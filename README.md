# Lender Backend

A comprehensive backend service for managing lender policies and eligibility rules, built with FastAPI, PostgreSQL, and Hatchet for workflow orchestration.

## Features

- **REST API**: Built with FastAPI for high performance and auto-generated documentation.
- **Database**: PostgreSQL with SQLAlchemy ORM and Alembic for migrations.
- **Workflow Orchestration**: Uses [Hatchet](https://hatchet.run/) for reliable background task processing (e.g., policy rule generation).
- **AI Integration**: Integration with Google Cloud for AI/ML tasks (inferred from config).

## Prerequisites

- **Python** 3.10 or higher
- **PostgreSQL** 14+
- **Hatchet Engine** (Self-hosted or Cloud)
- **Google Cloud Platform** account (for AI services)

## Installation & Setup

### 1. Clone the Repository

```bash
git clone <repository_url>
cd lender-backend
```

### 2. Set Up Virtual Environment

It is recommended to use a virtual environment to manage dependencies.

**Windows:**

```powershell
python -m venv venv
.\venv\Scripts\activate
```

**macOS/Linux:**

```bash
python3 -m venv venv
source venv/bin/activate
```

### 3. Install Dependencies

```bash
pip install -r requirements.txt
```

### 4. Configuration

Create a `.env` file in the root directory by copying the example:

**Windows:**

```powershell
copy .env.example .env
```

**macOS/Linux:**

```bash
cp .env.example .env
```

**Configure the `.env` file:**

Open `.env` and populate the following variables:

- **Database Settings**:

  ```ini
  POSTGRES_SERVER=localhost
  POSTGRES_USER=postgres
  POSTGRES_PASSWORD=your_password
  POSTGRES_DB=lender_db
  POSTGRES_PORT=5432
  ```

- **Hatchet Configuration** (Required for background workers):

  - Generate a Client Token from your Hatchet dashboard.

  ```ini
  HATCHET_CLIENT_TOKEN= your_hatchet_token_here
  ```

- **Google Cloud Configuration**:
  ```ini
  GOOGLE_PROJECT_ID=your_gcp_project_id
  GOOGLE_PROJECT_LOCATION=us-central1
  ```

### 5. Database Setup

1.  Make sure your PostgreSQL server is running.
2.  Create the database (if not using a tool to do it automatically):
    ```sql
    CREATE DATABASE lender_db;
    ```
3.  **Run Migrations**: Apply the database schema using Alembic.
    ```bash
    alembic upgrade head
    ```

## Running the Application

To handle both API requests and background workflows, you need to run two processes: the API server and the Hatchet worker.

### 1. Start the API Server

The API server handles HTTP requests and exposes the REST endpoints.

```bash
uvicorn app.main:app --reload
```

_The API will be available at `http://localhost:8000`._

### 2. Start the Worker

The worker processes background tasks orchestrated by Hatchet (e.g., parsing policies).

Open a **new terminal**, activate the virtual environment, and run:

```bash
# Ensure you are in the root directory and venv is activated
python -m app.worker
```

## API Documentation

Interactive API documentation is automatically generated by FastAPI:

- **Swagger UI**: [http://localhost:8000/docs](http://localhost:8000/docs)
- **ReDoc**: [http://localhost:8000/redoc](http://localhost:8000/redoc)

## Project Structure

```
lender-backend/
├── alembic/              # Database migration scripts
├── app/
│   ├── api/             # API route handlers
│   ├── core/            # Core config and database logic
│   ├── models/          # SQLAlchemy database models
│   ├── schemas/         # Pydantic models for validation
│   ├── utils/           # Utility functions
│   ├── workflows/       # Hatchet workflow definitions
│   ├── main.py          # App entry point
│   └── worker.py        # Worker entry point
├── uploads/              # Directory for file uploads
├── .env.example          # Environment variable template
├── alembic.ini           # Alembic configuration
├── requirements.txt      # Python dependencies
└── README.md             # This file
```

## Development Workflow

- **Database Migrations**:

  - Make changes to `app/models`.
  - Generate a migration: `alembic revision --autogenerate -m "describe changes"`
  - Apply migration: `alembic upgrade head`

- **Adding Dependencies**:
  - Install package: `pip install package_name`
  - Update requirements: `pip freeze > requirements.txt`
